<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>跨域资源共享CORS实战 | stay hungry, stay foolish.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="跨域资源共享CORS实战 CORS是一个W3C标准，全称“跨域资源共享”（Cross-origin resource sharing）；CORS定义了一种浏览器和服务器可以交互以确定允许跨院请求是否安全的方式。CORS协议需要浏览器和服务器端同时支持。  CORS协议 W3C的CORS规范将跨域资源请求划分为两种类型，“简单请求”和“非简单请求”。  简单请求定义要弄清楚CORS规范将哪些类型的跨">
<meta name="keywords" content="CORS">
<meta property="og:type" content="article">
<meta property="og:title" content="跨域资源共享CORS实战">
<meta property="og:url" content="https://huixw.github.io/2018/10/29/http-cors/index.html">
<meta property="og:site_name" content="stay hungry, stay foolish.">
<meta property="og:description" content="跨域资源共享CORS实战 CORS是一个W3C标准，全称“跨域资源共享”（Cross-origin resource sharing）；CORS定义了一种浏览器和服务器可以交互以确定允许跨院请求是否安全的方式。CORS协议需要浏览器和服务器端同时支持。  CORS协议 W3C的CORS规范将跨域资源请求划分为两种类型，“简单请求”和“非简单请求”。  简单请求定义要弄清楚CORS规范将哪些类型的跨">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-10-30T02:13:24.934Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="跨域资源共享CORS实战">
<meta name="twitter:description" content="跨域资源共享CORS实战 CORS是一个W3C标准，全称“跨域资源共享”（Cross-origin resource sharing）；CORS定义了一种浏览器和服务器可以交互以确定允许跨院请求是否安全的方式。CORS协议需要浏览器和服务器端同时支持。  CORS协议 W3C的CORS规范将跨域资源请求划分为两种类型，“简单请求”和“非简单请求”。  简单请求定义要弄清楚CORS规范将哪些类型的跨">
  
    <link rel="alternate" href="/atom.xml" title="stay hungry, stay foolish." type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">stay hungry, stay foolish.</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">To be or not to be,that is the question</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://huixw.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-http-cors" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/29/http-cors/" class="article-date">
  <time datetime="2018-10-29T07:06:55.000Z" itemprop="datePublished">2018-10-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/微服务/">微服务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      跨域资源共享CORS实战
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="跨域资源共享CORS实战"><a href="#跨域资源共享CORS实战" class="headerlink" title="跨域资源共享CORS实战"></a>跨域资源共享CORS实战</h1><blockquote>
<p>CORS是一个W3C标准，全称“跨域资源共享”（Cross-origin resource sharing）；CORS定义了一种浏览器和服务器可以交互以确定允许跨院请求是否安全的方式。CORS协议需要浏览器和服务器端同时支持。</p>
</blockquote>
<h1 id="CORS协议"><a href="#CORS协议" class="headerlink" title="CORS协议"></a>CORS协议</h1><blockquote>
<p>W3C的CORS规范将跨域资源请求划分为两种类型，“简单请求”和“非简单请求”。</p>
</blockquote>
<h2 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>要弄清楚CORS规范将哪些类型的跨域资源请求划分为简单请求的范畴，需要额外理解几个名称的含义：</p>
<ul>
<li><p>简单（HTTP）方法</p>
<p>CORS规范将 <strong>GET</strong> 、<strong>HEAD</strong> 和 <strong>POST</strong> 这三个HTTP方法时为 <strong>简单HTTP方法</strong>；</p>
</li>
<li><p>简单（请求）报头（Simple Header）</p>
<p>CORS规范将请求报头为 <strong>Accept</strong>、<strong>Accept-Language</strong>、<strong>Content-Language</strong> 以及 <strong>Content-Type</strong> 为（<strong>application/x-www-form-urlencoded</strong>、<strong>multipart/form-data</strong>、<strong>text-plain</strong> ）的请求报头称为 <strong>简单请求报头</strong>；</p>
</li>
<li><p>自定义请求报头（Author Request Header/Custom Request Header)</p>
<p>请求报头包括两种，一种是通脱浏览器自动生成的报头，另外一种是由Javascript程序自动添加的报头（比如调用<strong>XMLHttpRequest</strong>的<strong>setRequestHeader</strong>方法可以添加任意报头），后者称为<strong>自定义报头</strong>。</p>
</li>
</ul>
<blockquote>
<p>CORS规范将满足如下条件的的请求定义为简单请求：请求采用 <strong>简单HTTP方法</strong> ，并且 <strong>自定义请求报头</strong> 为空，或者<strong>自定义报头</strong> 为 <strong>简单请求报头</strong>。</p>
</blockquote>
<h3 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h3><blockquote>
<p>对于简单请求，浏览器直接发出CORS请求。具体来说就是在头信息中增加一个 <strong>Origin</strong> 字段。如：</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/api/operator/v1/get1</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Origin</span>: http://api.a.com</span><br><span class="line"><span class="attribute">Host</span>: api.b.com</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36</span><br></pre></td></tr></table></figure>
<p>​    上面的信息头中 <strong>Origin</strong> 字段用来说明本次请求来自哪个源（协议+域名+端口）。服务器根据这个值决定是否同意这次请求。客户端根据返回请求判断相应头是否包含 <strong>Access-Control-Allow-Origin</strong> 字段来判断请求是否允许。这种错误无法通过状态码识别，因为HTTP回应的状态码可能是200。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: http://api.a.com</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span>: true</span><br><span class="line"><span class="attribute">Access-Control-Expose-Headers</span>: myHeader</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=utf-8</span><br></pre></td></tr></table></figure>
<p>​    上面的信息之中 <strong>Access-Control</strong> 打头的的属性是与CORS请求相关的。</p>
<ul>
<li><p>Access-Control-Allow-Origin</p>
<p>该字段是必须的。它的值要么是请求时 <strong>Origin</strong> 的值，要么是一个 <strong>*</strong>；且不支持通配符；</p>
</li>
<li><p>Access-Control-Allow-Credentials</p>
<p>该字段可选；boolean值，表示是否允许发送Cookie，默认为false。设为True表名服务器明确许可，Cookie可以包含在请求中，一起发送给服务器。</p>
<p>同时开发者也必须在AJAX请求中打开withCredentials属性，如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.withCredentials = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Access-Control-Expose-Headers</p>
<p>该字段可选。CORS请求是，<em>XMLHttpRequest</em> 对象的 <em>getResponseHeader()</em> 方法只能拿到6个基本字段（基本相应报文头）：<em>Cache-Control</em> 、 <em>Content-Language</em> 、<em>Content-Type</em>、<em>Expires</em>、<em>Last-Modified</em>、<em>Pragma</em>。 如果想拿到其他字段就必须在Access-Control-Expose-Headers里面指定。</p>
</li>
</ul>
<h2 id="非简单请求"><a href="#非简单请求" class="headerlink" title="非简单请求"></a>非简单请求</h2><blockquote>
<p>对于不是简单请求的跨域请求，则被称为非简单请求；非简单请求的CORS请求，会在正式通信之前增加一次HTTP查询请求，称为“预检”请求。</p>
</blockquote>
<h3 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h3><blockquote>
<p>预检请求是一种OPTIONS类型的请求，请求服务器端接口访问权限。下面以访问接口 operator/get为例；</p>
</blockquote>
<p>请求报文：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">OPTIONS</span> <span class="string">/api/operator/v1/get2</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: api.b.com</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="attribute">Access-Control-Request-Method</span>: GET</span><br><span class="line"><span class="attribute">Origin</span>: http://api.a.com</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36</span><br><span class="line"><span class="attribute">Access-Control-Request-Headers</span>: content-type</span><br><span class="line"><span class="attribute">Accept</span>: */*</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9,en;q=0.8</span><br></pre></td></tr></table></figure>
<p>响应报文：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">204</span></span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: http://api.a.com</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span>: GET, HEAD, POST, PUT, DELETE, OPTIONS</span><br><span class="line"><span class="attribute">Access-Control-Max-Age</span>: 3600</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span>: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span>: true</span><br><span class="line"><span class="attribute">Date</span>: Fri, 26 Oct 2018 10:16:31 GMT</span><br></pre></td></tr></table></figure>
<p>​    如果浏览器否定了“预检”请求，会返回一个正常的HTTP回应，但是没有任何CORS相关的头信息字段。这是，浏览器就会认定服务器不同意预检请求，并因此触发一个错误。</p>
<p>​    服务器相应的其他CORS相关字段：</p>
<ul>
<li><p>Access-Control-Allow-Methods</p>
<p>该字段必须；他是逗号分隔的一个字符串，表名服务器支持的所有跨域方法。注意，返回的是所有支持的方法；</p>
</li>
<li><p>Access-Control-Allow-Headers</p>
<p>如果浏览器请求包括<strong>Access-Control-Request-Header</strong> ,则 Access-Control-Allow-Header字段是必须的。它也是逗号分隔的一个字符串；</p>
</li>
<li><p>Access-Control-Allow-Credentials</p>
<p>与简单请求含义相同；</p>
</li>
<li><p>Access-Control-Max-Age</p>
<p>该字段可选，用来指定背刺预检请求的有效期，单位为“秒”</p>
</li>
</ul>
<h3 id="基本流程-1"><a href="#基本流程-1" class="headerlink" title="基本流程"></a>基本流程</h3><blockquote>
<p>一旦服务器通过了“预检”请求，以后每次浏览器正常CORS请求，和简单请求一样，会有一个 <strong>Origin</strong> 头信息字段。服务器的回应，也都会有一个 <strong>Access-Control-Allow-Origin</strong> 头信息字段。</p>
</blockquote>
<h1 id="服务器端实现CORS"><a href="#服务器端实现CORS" class="headerlink" title="服务器端实现CORS"></a>服务器端实现CORS</h1><h2 id="WEB容器配置实现"><a href="#WEB容器配置实现" class="headerlink" title="WEB容器配置实现"></a>WEB容器配置实现</h2><h3 id="NGINX配置实现CORS"><a href="#NGINX配置实现CORS" class="headerlink" title="NGINX配置实现CORS"></a>NGINX配置实现CORS</h3><blockquote>
<p>通过Nginx反向代理，对Http请求进行拦截处理以实现服务器端跨域</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">   <span class="comment"># 检查域名后缀</span></span><br><span class="line">   <span class="attribute">if</span> (<span class="variable">$http_origin</span> <span class="regexp">~ \.test\.com)</span> &#123;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Allow-Origin <span class="variable">$http_origin</span>;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Allow-Methods GET,POST,OPTIONS;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Allow-Credentials <span class="literal">true</span>;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Allow-Headers DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Max-Age <span class="number">1728000</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment"># options请求不转给后端，直接返回204</span></span><br><span class="line">   <span class="comment"># 第二个if会导致上面的add_header无效，这是nginx的问题，这里直接重复执行下</span></span><br><span class="line">   <span class="attribute">if</span> (<span class="variable">$request_method</span> = OPTIONS) &#123;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Allow-Origin <span class="variable">$http_origin</span>;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Allow-Methods GET,POST,OPTIONS;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Allow-Credentials <span class="literal">true</span>;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Allow-Headers DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type;</span><br><span class="line">        <span class="attribute">add_header</span> Access-Control-Max-Age <span class="number">1728000</span>;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">204</span>;</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="comment"># 其他请求代理到后端</span></span><br><span class="line">   <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">   <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Scheme <span class="variable">$scheme</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">   <span class="attribute">proxy_pass</span> http://xxx.xxx.xxx.xxx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>优点：配置简单，实现便捷快速</li>
<li>缺点：配置上稍显麻烦，安全验证上偏弱，不够灵活</li>
</ul>
<h3 id="SpringMVC-代码实现CORS跨域"><a href="#SpringMVC-代码实现CORS跨域" class="headerlink" title="SpringMVC 代码实现CORS跨域"></a>SpringMVC 代码实现CORS跨域</h3><h4 id="Java-Servlet-Filter实现Cors"><a href="#Java-Servlet-Filter实现Cors" class="headerlink" title="Java Servlet Filter实现Cors"></a>Java Servlet Filter实现Cors</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.my.web.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@WebFilter</span>(urlPatterns = <span class="string">"/*"</span>)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CrosFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletResponse response = (HttpServletResponse) servletResponse;</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line"></span><br><span class="line">        String origin = request.getHeader(<span class="string">"Origin"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(origin)) &#123;</span><br><span class="line">            response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, origin);</span><br><span class="line">        &#125;</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"GET, HEAD, POST, PUT, DELETE, OPTIONS"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Max-Age"</span>, <span class="string">"3600"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"OPTIONS"</span>.equals(request.getMethod())) &#123;</span><br><span class="line">            response.setStatus(HttpStatus.NO_CONTENT.value());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>优点：可以加入自定义逻辑，进行全局配置，也可以进行细微控制</li>
<li>缺点：多个拦截器是需要注意拦截器的顺序</li>
</ul>
<h4 id="SpringMVC-addCorsMappings实现"><a href="#SpringMVC-addCorsMappings实现" class="headerlink" title="SpringMVC addCorsMappings实现"></a>SpringMVC addCorsMappings实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.my.web.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Splitter;</span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Iterables;</span><br><span class="line"><span class="keyword">import</span> com.xiwei.marketing.web.interceptor.LoginInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurationSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LoginInterceptor loginInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;privilege.white.request.urls&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String whiteUrls;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cross.origins&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String crossOrigins;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(loginInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">"/**"</span>)</span><br><span class="line">                .excludePathPatterns(Iterables.toArray(Splitter.on(<span class="string">','</span>).split(whiteUrls), String.class));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">"/**"</span>)</span><br><span class="line">                .allowedOrigins(Iterables.toArray(Splitter.on(<span class="string">','</span>).split(crossOrigins), String.class))</span><br><span class="line">                .allowedMethods(<span class="string">"GET"</span>, <span class="string">"HEAD"</span>, <span class="string">"POST"</span>,<span class="string">"PUT"</span>, <span class="string">"DELETE"</span>, <span class="string">"OPTIONS"</span>)</span><br><span class="line">                .allowCredentials(<span class="keyword">true</span>)</span><br><span class="line">                .maxAge(<span class="number">86400</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>优点：配置优雅，简单</li>
<li>缺点：如果程序中有使用拦截器对Cookie进行登录验证时，拦截器的殊勋会在CorsMapping之前，导致认证失败，在使用Cookie进行登录认证时采用了 Filter实现的方式。</li>
</ul>
<h4 id="CrossOrigin注解"><a href="#CrossOrigin注解" class="headerlink" title="@CrossOrigin注解"></a>@CrossOrigin注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br></pre></td></tr></table></figure>
<ul>
<li>优点：可加入到每个具体上API方法上，实现简单</li>
<li>缺点：通addCrosmappings全局配置</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在进行前后端分离的微服务架构中，在服务器端分别尝试了三种方法，由于需要用到浏览器Cookie，后两种在Cookie支持上没有很好的办法，最终从安全上，可配置上，考虑采用了使用拦截器的方式。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://huixw.github.io/2018/10/29/http-cors/" data-id="cjnv4v5j3000jb2apttiaqv18" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CORS/">CORS</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/10/23/nginx-auth-request-module/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">Nginx搭建建议有权限的文件服务器</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Catégories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/program-language/">program language</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spark/">spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂项/">杂项</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Mot-clés</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CORS/">CORS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/anaconda/">anaconda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cdh/">cdh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/consul/">consul</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design-patterns/">design patterns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/graphx/">graphx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/machine-learning/">machine learning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openvpn/">openvpn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proxy/">proxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitmq/">rabbitmq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rpm/">rpm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/">scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/squid/">squid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zakaban/">zakaban</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排序/">排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/机器学习/">机器学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/评估/">评估</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nuage de mot-clés</h3>
    <div class="widget tagcloud">
      <a href="/tags/CORS/" style="font-size: 10px;">CORS</a> <a href="/tags/anaconda/" style="font-size: 10px;">anaconda</a> <a href="/tags/cdh/" style="font-size: 10px;">cdh</a> <a href="/tags/consul/" style="font-size: 10px;">consul</a> <a href="/tags/design-patterns/" style="font-size: 10px;">design patterns</a> <a href="/tags/graphx/" style="font-size: 10px;">graphx</a> <a href="/tags/hexo/" style="font-size: 20px;">hexo</a> <a href="/tags/machine-learning/" style="font-size: 10px;">machine learning</a> <a href="/tags/nginx/" style="font-size: 20px;">nginx</a> <a href="/tags/openvpn/" style="font-size: 10px;">openvpn</a> <a href="/tags/proxy/" style="font-size: 10px;">proxy</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/rabbitmq/" style="font-size: 10px;">rabbitmq</a> <a href="/tags/rpm/" style="font-size: 10px;">rpm</a> <a href="/tags/scala/" style="font-size: 20px;">scala</a> <a href="/tags/squid/" style="font-size: 10px;">squid</a> <a href="/tags/zakaban/" style="font-size: 10px;">zakaban</a> <a href="/tags/排序/" style="font-size: 10px;">排序</a> <a href="/tags/机器学习/" style="font-size: 20px;">机器学习</a> <a href="/tags/评估/" style="font-size: 10px;">评估</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/10/29/http-cors/">跨域资源共享CORS实战</a>
          </li>
        
          <li>
            <a href="/2018/10/23/nginx-auth-request-module/">Nginx搭建建议有权限的文件服务器</a>
          </li>
        
          <li>
            <a href="/2018/09/20/consul-note/">Consul使用笔记</a>
          </li>
        
          <li>
            <a href="/2018/08/29/scala-learning/">《Scala程序设计(第2版)》读书笔记</a>
          </li>
        
          <li>
            <a href="/2018/06/23/squid-install/">linux代理服务器squid</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 sivan<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>